name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      DALAMUD_HOME: ${{ github.workspace }}\dalamud
      PROJECT_DIR: Supply-Mission-Helper       # <-- adjust if your csproj is not in this folder
      PROJECT_FILE: SupplyMissionHelper.csproj

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'              # <-- match your csproj TFM (change if needed)

      - name: Download Dalamud distributable
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $dl = "https://goatcorp.github.io/dalamud-distrib/latest.zip"
          Invoke-WebRequest -Uri $dl -OutFile latest.zip
          New-Item -ItemType Directory -Force -Path "$env:DALAMUD_HOME" | Out-Null
          Expand-Archive -Path latest.zip -DestinationPath "$env:DALAMUD_HOME" -Force
          Write-Host "Expanded Dalamud to: $env:DALAMUD_HOME"
          Write-Host "Tree:"
          Get-ChildItem "$env:DALAMUD_HOME" -Recurse | Select-Object FullName

      - name: Build
        shell: pwsh
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          $ErrorActionPreference = 'Stop'
          $DalamudLibPath = (Join-Path "$env:DALAMUD_HOME" "bin\")  # must end with slash
          Write-Host "DalamudLibPath=$DalamudLibPath"
          dotnet build ".\$env:PROJECT_FILE" -c Release /p:DalamudLibPath="$DalamudLibPath"

      - name: Verify Build Output
        shell: pwsh
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          $ErrorActionPreference = 'Stop'
          # Find the produced DLL under bin/Release/**/SupplyMissionHelper.dll
          $dll = Get-ChildItem -Path "bin\Release" -Recurse -Filter "SupplyMissionHelper.dll" | Select-Object -First 1
          if (-not $dll) {
            Write-Host "Contents of bin/Release:"
            Get-ChildItem "bin\Release" -Recurse | Select-Object FullName
            throw "Build output not found."
          }
          Write-Host "âœ“ Build output found at $($dll.FullName)"
          # Save path for packaging
          echo "DLL_PATH=$($dll.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Package
        shell: pwsh
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path "release" | Out-Null
          Copy-Item "$env:DLL_PATH" -Destination "release\"
          Copy-Item "SupplyMissionHelper.json" -Destination "release\"
          Compress-Archive -Path "release\*" -DestinationPath "SupplyMissionHelper.zip" -Force
          Write-Host "Created package: $(Resolve-Path .\SupplyMissionHelper.zip)"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SupplyMissionHelper
          path: ${{ env.PROJECT_DIR }}\SupplyMissionHelper.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.PROJECT_DIR }}\SupplyMissionHelper.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
