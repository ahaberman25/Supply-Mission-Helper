name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      DALAMUD_HOME: ${{ github.workspace }}\dalamud
      PROJECT_DIR: .                      # << if your .csproj is in the repo root; change if not
      PROJECT_FILE: SupplyMissionHelper.csproj

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show workspace (debug)
        shell: pwsh
        run: |
          Write-Host "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          Get-ChildItem -Recurse -Depth 2 | Select-Object FullName

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'         # match your .csproj TFM

      - name: Download Dalamud distributable
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/latest.zip -OutFile latest.zip
          New-Item -ItemType Directory -Force -Path "$env:DALAMUD_HOME" | Out-Null
          Expand-Archive -Path latest.zip -DestinationPath "$env:DALAMUD_HOME" -Force
          Write-Host "Expanded: $env:DALAMUD_HOME"
          Get-ChildItem "$env:DALAMUD_HOME\bin" | Select-Object FullName

      - name: Build
        shell: pwsh
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          $ErrorActionPreference = 'Stop'
          $DalamudLibPath = (Join-Path "$env:DALAMUD_HOME" "bin\")
          Write-Host "DalamudLibPath=$DalamudLibPath"
          dotnet build ".\$env:PROJECT_FILE" -c Release /p:DalamudLibPath="$DalamudLibPath"

      - name: Verify Build Output
        shell: pwsh
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          $ErrorActionPreference = 'Stop'
          $dll = Get-ChildItem -Path "bin\Release" -Recurse -Filter "SupplyMissionHelper.dll" | Select-Object -First 1
          if (-not $dll) {
            Write-Host "Contents of bin/Release:"
            Get-ChildItem "bin\Release" -Recurse | Select-Object FullName
            throw "Build output not found."
          }
          Write-Host "âœ“ Found $($dll.FullName)"
          echo "DLL_PATH=$($dll.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Package
        shell: pwsh
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path "release" | Out-Null
          Copy-Item "$env:DLL_PATH" -Destination "release\"
          Copy-Item "SupplyMissionHelper.json" -Destination "release\"
          Compress-Archive -Path "release\*" -DestinationPath "SupplyMissionHelper.zip" -Force
          Write-Host "Created package: $(Resolve-Path .\SupplyMissionHelper.zip)"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SupplyMissionHelper
          path: ${{ env.PROJECT_DIR }}\SupplyMissionHelper.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.PROJECT_DIR }}\SupplyMissionHelper.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
